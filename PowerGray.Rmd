---
title: "36-315 Lab 10, Spring 2018"
author: "Austin Yu (zongchuy), Bryan Yan (bryanyan), Josh Huang (jzh1), Julie Kim (juliek1)"
date: "Due Friday, April 27, 2018 (6:30pm) on Canvas"
output: 
  html_document:
    toc:  true
    toc_float:  true
    code_folding:  show
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load-In
===
+ Load necessary libraries
+ Load data from `data.csv`
+ Check dimensions of the data, expecting a 3441197 x 7 dataframe
+ Return the first 5 rows
```{r, message = FALSE, warning = FALSE}
setwd('/Users/bryanyan/Desktop/cmusenior/spring18/36-315/final/36-315-Interactive-Graphics')
library(tidyverse)
library(dplyr)
library(plyr)
library(shiny)
library(rsconnect)
library(ggplot2)
library(igraph)
library(ggraph)
library(ggmap)
library(maps)
library(sp)
library(scales)

data = read.csv("data.csv")

dim(data)
head(data, 5)
```


Data Manipulation
===

+ Write a `date.to.month()` helper function, which takes in a date in the form YEAR-MONTH-DAY and converts it to a month
+ E.g. date.to.month(2017-01-26) returns January
+ Apply `date.to.month()` across the `Date` column of our data, creating a new column `Month`
```{r}
date.to.month = function(date) {
  date = as.character(date)
  month.numeric = as.numeric(unlist(strsplit(date, "-")))[2]
  return(month.name[month.numeric])
}

data$Month = sapply(data$Date, date.to.month)
```

+ Create a vector of countries based off of the country codes that we have in our `Region` column
+ Write a `code.to.country()` function that takes in a country code and returns the country
+ E.g. `code.to.country("ec")` returns "Ecuador"
+ Apply `code.to.country()`across the `Region` column of our data, creating a new column `Country`
```{r}
countries = unique(data$Region)
names(countries) = c("Ecuador", "France", "Argentina", "Finland", "Norway", "Italy", "Lithuania", "Philippines", "Taiwan", "New Zealand", "Estonia", "Turkey", "United States of America", "El Salvador", "Costa Rica", "Germany", "Chile", "Japan", "Brazil", "Honduras", "Guatemala", "Switzerland", "Hungary", "Canada", "Peru", "Belgium", "Malaysia", "Denmark", "Bolivia", "Poland", "Austria", "Portugal", "Sweden", "Mexico", "Panama", "Uruguay", "Iceland", "Spain", "Czech Republic", "Ireland", "Netherlands", "Slovakia", "Colombia", "Singapore", "Indonesia", "Dominican Republic", "Luxembourg", "United Kingdom", "World", "Paraguay", "Australia", "Latvia", "Greece", "Hong Kong")

code.to.country = function(code) {
  code = as.character(code)
  return(names(countries)[which(countries == code)])
}

data$Country = sapply(data$Region, code.to.country)
```

+ Create a vector of continents based off of the countries that we have in our `Country` column
+ Write a `country.to.continent()` function that takes in a country code and returns the continent
+ E.g. `country.to.continent("Ecuador")` returns "South America"
+ Apply `country.to.continent()`across the `Country` column of our data, replacing the column `Region`
```{r}
world = c("World")
asia = c("Philippines", "Taiwan", "Japan", "Malaysia", "Singapore", "Indonesia", 
         "Hong Kong")
europe = c("France", "Finland", "Norway", "Italy", "Lithuania", "Estonia", 
           "Turkey", "Germany", "Switzerland", "Hungary", "Belgium", "Denmark", 
           "Poland", "Austria", "Portugal", "Sweden", "Iceland", "Spain", 
           "Czech Republic", "Ireland", "Netherlands", "Slovakia", "Luxembourg", 
           "United Kingdom", "Latvia", "Greece")
northamerica = c("United States of America", "Canada", "Mexico")
centralamerica = c("El Salvador", "Costa Rica", "Honduras", "Guatemala", 
                   "Panama", "Dominican Republic")
southamerica = c("Ecuador", "Argentina", "Chile", "Brazil", "Peru", "Bolivia", 
                 "Uruguay", "Colombia", "Paraguay")
oceania = c("New Zealand", "Australia")

country.to.continent = function(country) {
  country = as.character(country)
  if (country %in% world) return("World")
  if (country %in% asia) return("Asia")
  if (country %in% europe) return("Europe")
  if (country %in% northamerica) return("North America")
  if (country %in% centralamerica) return("Central America")
  if (country %in% southamerica) return("South America")
  if (country %in% oceania) return("Oceania")
  return(NA)
}

data$Region = sapply(data$Country, country.to.continent)
```

+ Statistical summaries to get a sense of the data
```{r}
# Summary statistics on top 200 streams, world wide
streams = summary(data$Streams)
# Summary statistics on top 200 streams, by country
streams.by.country = ddply(data, .(Country), function(x) summary(x$Streams))
# Summary statistics on top 200 streams, by continent
streams.by.cont = ddply(data, .(Region), function(x) summary(x$Streams))

# Total streams, world wide
tot.streams = sum(as.numeric(data$Streams))
# Summary statistics on top 200 streams, by country
tot.streams.by.country = ddply(data, .(Country), function(x) sum(as.numeric(x$Streams)))
# Summary statistics on top 200 streams, by continent
tot.streams.by.cont = ddply(data, .(Region), function(x) sum(as.numeric(x$Streams)))

# How many times did Artists end up in the top 200 rankings, world wide?
artists = as.data.frame(table(data$Artist))
# How many times did Artists end up in the top 200 rankings, by country?
artists.by.country = ddply(data, .(Country), function(x) table(x$Artist))
# How many times did Artists end up in the top 200 rankings, by continent?
artists.by.cont = ddply(data, .(Region), function(x) table(x$Artist))

colnames(tot.streams.by.country)[2] = "Total_Streams"
country.data = left_join(tot.streams.by.country, artists.by.country, by = "Country")
```


Graphics
===

```{r}
shinyApp(
  
  ui = fluidPage(
    inputPanel(
      selectInput("country", label = "Country",
                  choices = unique(data$Country), 
                  selected = "United States of America"),
      
      selectInput("country2", label = "Country 2",
                  choices = unique(data$Country),
                  selected = "Canada"),
      
      textInput("song", label = "Song Name", 
                     value = "rockstar"),
      
      textInput("artist", label = "Artist Name", 
                     value = "Post Malone")
    ),
    
    plotOutput("top_ranking_time")
  ),
  
  server = function(input, output) {
    
    dataSub <- reactive({
        if (input$song == "") {
          chosenSong <- " "
        }
        else {
          chosenSong <- input$song 
        }
        subset(data, Track.Name == chosenSong &
               Artist == input$artist &
              (Country == input$country | Country == input$country2))
    })
    
    output$top_ranking_time <- renderPlot({
      subsetOfData <- dataSub()
      if (nrow(subsetOfData) == 0) {
        ggplot() + 
          annotate("text", 
                   x = 4, y = 25, size = 8, label = "Song/Artist Not Found") + 
          theme_void() +
          labs(x = NULL, y = NULL)
      }
      else {
        ggplot(subsetOfData, aes(x = as.Date(Date), y = Streams, 
                                 color = Country, group = Country)) +
          scale_x_date(date_labels = "%b %y") +
          scale_y_continuous(labels = comma) +
          geom_point() +
          geom_line() +
          labs(title = "Song Streams by Country Over Time",
                x = "Date",
                y = "Number of Streams") +
          theme(axis.title.y = 
                  element_text(margin = margin(r = 20)),
                axis.title.x =
                  element_text(margin = margin(t = 20)))
      }
    })
  },
  
  options = list(height = 550)
)
```
